<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Database File - Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #004080, #0073e6);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .upload-container {
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-section img {
      width: 80px;
      margin-bottom: 10px;
    }

    .logo-section h1 {
      color: #003366;
      font-size: 2em;
      margin-bottom: 5px;
    }

    .logo-section p {
      color: #666;
      font-size: 0.9em;
    }

    .upload-area {
      border: 3px dashed #0073e6;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background-color: #f0f8ff;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #004080;
      background-color: #e6f3ff;
    }

    .upload-area.dragover {
      border-color: #004080;
      background-color: #cce6ff;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3em;
      margin-bottom: 15px;
    }

    .upload-text {
      color: #003366;
      font-size: 1.1em;
      margin-bottom: 10px;
    }

    .upload-hint {
      color: #666;
      font-size: 0.9em;
    }

    input[type="file"] {
      display: none;
    }

    .file-info {
      margin-top: 20px;
      padding: 15px;
      background-color: #e8f5e9;
      border-radius: 8px;
      display: none;
    }

    .file-info.show {
      display: block;
    }

    .file-name {
      color: #2e7d32;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .file-size {
      color: #666;
      font-size: 0.9em;
    }

    .submit-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(to right, #004080, #0073e6);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      margin-top: 20px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 115, 230, 0.4);
    }

    .submit-button:active {
      transform: translateY(0);
    }

    .submit-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
    }

    .back-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .error-message {
      background-color: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9em;
      display: none;
      border-left: 4px solid #c62828;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background-color: #e8f5e9;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9em;
      display: none;
      border-left: 4px solid #2e7d32;
    }

    .success-message.show {
      display: block;
    }

    /* Loading Modal Styles */
    .loading-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }

    .loading-modal.show {
      display: flex;
    }

    .loading-content {
      background-color: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0073e6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #003366;
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .loading-details {
      color: #666;
      font-size: 0.9em;
    }
  </style>
  <!-- SheetJS Library for Excel to JSON conversion -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <button class="back-button" onclick="window.location.href='admin-panel.html'">‚Üê Back</button>
  
  <div class="upload-container">
    <div class="logo-section">
      <img src="assets/haveels2.png" alt="Havells Logo">
      <h1>Upload Database File</h1>
      <p>Upload a JSON file for pump recommendations</p>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">Click to select or drag & drop</div>
      <div class="upload-hint">JSON or Excel files (.json, .xlsx, .xls)</div>
      <input type="file" id="fileInput" accept=".json,.xlsx,.xls" />
    </div>

    <div class="file-info" id="fileInfo">
      <div class="file-name" id="fileName"></div>
      <div class="file-size" id="fileSize"></div>
    </div>

    <button class="submit-button" id="submitButton" onclick="uploadFile()" disabled>Upload File</button>
  </div>

  <!-- Loading Modal -->
  <div class="loading-modal" id="loadingModal">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Converting Excel to JSON...</div>
      <div class="loading-details" id="loadingDetails">Please wait, this may take a moment</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script src="scripts/cloud-sync.js"></script>
  <script src="scripts/database.js"></script>
  <script src="scripts/auth.js"></script>
  
  <script>
    // Initialize Firebase and Cloud Sync
    window.addEventListener('DOMContentLoaded', async () => {
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDZLujiFxX-BJ98bRiNKv5VYYYfpwG0Yn4",
        authDomain: "pumpselector-74a7a.firebaseapp.com",
        projectId: "pumpselector-74a7a",
        storageBucket: "pumpselector-74a7a.firebasestorage.app",
        messagingSenderId: "189246777584",
        appId: "1:189246777584:web:a4165d94ee76283d3dba35",
        measurementId: "G-WMD6QW8670"
      };
      
      // Initialize cloud sync
      if (typeof cloudSync !== 'undefined') {
        cloudSync.setConfig(firebaseConfig);
        await cloudSync.init();
      }
    });
  </script>
  <script>
    // Check if user is admin
    window.addEventListener('DOMContentLoaded', () => {
      if (!authManager.isAdmin()) {
        alert('Access denied. Admin privileges required.');
        window.location.href = 'index.html';
      }

      // Setup file input
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const submitButton = document.getElementById('submitButton');

      // Click to select file
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      function handleFileSelect(file) {
        // Validate file type
        const validExtensions = ['.json', '.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!validExtensions.includes(fileExtension)) {
          showError('Please select a JSON or Excel file (.json, .xlsx, .xls).');
          return;
        }

        // Show file info
        fileName.textContent = file.name;
        fileSize.textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
        fileInfo.classList.add('show');
        submitButton.disabled = false;
        window.selectedFile = file;
        window.fileExtension = fileExtension;
      }
    });

    async function uploadFile() {
      const file = window.selectedFile;
      if (!file) {
        showError('Please select a file first.');
        return;
      }

      const submitButton = document.getElementById('submitButton');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const loadingModal = document.getElementById('loadingModal');
      const loadingText = document.getElementById('loadingText');
      const loadingDetails = document.getElementById('loadingDetails');

      // Hide previous messages
      errorMessage.classList.remove('show');
      successMessage.classList.remove('show');

      // Disable button
      submitButton.disabled = true;
      submitButton.textContent = 'Uploading...';

      try {
        let fileData;
        const fileExtension = window.fileExtension || '.' + file.name.split('.').pop().toLowerCase();

        // Check if it's an Excel file
        if (fileExtension === '.xlsx' || fileExtension === '.xls') {
          // Show loading modal for Excel conversion
          loadingModal.classList.add('show');
          loadingText.textContent = 'Converting Excel to JSON...';
          loadingDetails.textContent = 'Reading Excel file...';

          // Convert Excel to JSON
          fileData = await convertExcelToJSON(file, loadingDetails);
          
          loadingText.textContent = 'Conversion complete!';
          loadingDetails.textContent = 'Saving to database...';
        } else {
          // It's a JSON file, read it directly
          fileData = await readFileAsText(file);
        }

        // Validate JSON with better error messages
        let parsedData;
        try {
          // If fileData is already an object (from Excel conversion), use it directly
          if (typeof fileData === 'object') {
            parsedData = fileData;
            fileData = JSON.stringify(fileData, null, 2); // Convert to string for storage
          } else {
            // Try to parse JSON string
            parsedData = JSON.parse(fileData);
          }
        } catch (e) {
          loadingModal.classList.remove('show');
          // Provide more detailed error message
          const errorMsg = e.message || 'Unknown error';
          let detailedError = `Invalid JSON format: ${errorMsg}`;
          
          // Try to find the line number if position is available
          const positionMatch = errorMsg.match(/position (\d+)/);
          if (positionMatch) {
            try {
              const position = parseInt(positionMatch[1]);
              const lines = fileData.substring(0, position).split('\n');
              const lineNumber = lines.length;
              const columnNumber = lines[lines.length - 1].length + 1;
              detailedError += `\n\nError at line ${lineNumber}, column ${columnNumber}`;
              
              // Show a snippet of the problematic line
              if (lines.length > 0 && lines[lines.length - 1]) {
                const problemLine = lines[lines.length - 1].substring(0, 100);
                detailedError += `\nProblematic line: "${problemLine}..."`;
              }
            } catch (lineError) {
              // If we can't calculate line number, just show the error
            }
          }
          
          throw new Error(detailedError);
        }

        // Additional validation - check if it's an array or object
        if (!Array.isArray(parsedData) && typeof parsedData !== 'object') {
          loadingModal.classList.remove('show');
          throw new Error('File must contain an array or object.');
        }

        // Check if it's empty
        if (Array.isArray(parsedData) && parsedData.length === 0) {
          loadingModal.classList.remove('show');
          throw new Error('File is empty. Please upload a file with data.');
        }

        // Save to database
        const fileName = file.name.replace(/\.(xlsx|xls)$/i, '.json'); // Change extension to .json
        await pumpDB.saveDatabaseFile(fileName, fileData, 'json');

        // Hide loading modal
        loadingModal.classList.remove('show');

        successMessage.textContent = 'File uploaded and converted successfully!';
        successMessage.classList.add('show');

        // Reset form
        setTimeout(() => {
          window.location.href = 'view-database.html';
        }, 1500);
      } catch (error) {
        loadingModal.classList.remove('show');
        errorMessage.textContent = error.message || 'Failed to upload file. Please try again.';
        errorMessage.classList.add('show');
        submitButton.disabled = false;
        submitButton.textContent = 'Upload File';
      }
    }

    // Convert Excel file to JSON
    async function convertExcelToJSON(file, loadingDetails) {
      return new Promise((resolve, reject) => {
        try {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            try {
              loadingDetails.textContent = 'Processing Excel data...';
              
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              // Get the first sheet (or you could let user choose)
              const firstSheetName = workbook.SheetNames[0];
              loadingDetails.textContent = `Converting sheet: ${firstSheetName}...`;
              
              const worksheet = workbook.Sheets[firstSheetName];
              
              // Convert to JSON array format (similar to your pump-data.json structure)
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1, // Use first row as header
                defval: null // Default value for empty cells
              });
              
              // Convert to object array format (like your original JSON)
              // First row is headers, rest are data
              if (jsonData.length < 2) {
                throw new Error('Excel file must have at least a header row and one data row.');
              }
              
              loadingDetails.textContent = 'Formatting JSON structure...';
              
              // Convert array of arrays to array of objects
              const headers = jsonData[0];
              const result = jsonData.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                  // Trim header to remove extra spaces but preserve the actual name
                  // Use header if available, otherwise create ColumnN
                  const columnName = header ? String(header).trim() : `Column${index + 1}`;
                  // Handle cell values: preserve actual values, convert empty/undefined/null to null
                  const cellValue = row[index];
                  // Check if value exists and is not empty string (after trimming if string)
                  if (cellValue !== undefined && cellValue !== null) {
                    const trimmedValue = typeof cellValue === 'string' ? cellValue.trim() : cellValue;
                    obj[columnName] = trimmedValue !== '' ? cellValue : null;
                  } else {
                    obj[columnName] = null;
                  }
                });
                return obj;
              });
              
              // Add header row as first element (to match your original format)
              const headerObj = {};
              headers.forEach((header, index) => {
                // Trim header names consistently
                const columnName = header ? String(header).trim() : `Column${index + 1}`;
                headerObj[columnName] = header ? String(header).trim() : `Column${index + 1}`;
              });
              
              const finalResult = [headerObj, ...result];
              
              loadingDetails.textContent = 'Conversion complete!';
              
              resolve(finalResult);
            } catch (error) {
              reject(new Error(`Error converting Excel: ${error.message}`));
            }
          };
          
          reader.onerror = function() {
            reject(new Error('Failed to read Excel file.'));
          };
          
          reader.readAsArrayBuffer(file);
        } catch (error) {
          reject(new Error(`Error processing Excel file: ${error.message}`));
        }
      });
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          let text = e.target.result;
          
          // Remove BOM (Byte Order Mark) if present
          if (text.charCodeAt(0) === 0xFEFF) {
            text = text.slice(1);
          }
          
          // Trim whitespace
          text = text.trim();
          
          resolve(text);
        };
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsText(file, 'UTF-8');
      });
    }

    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
    }
  </script>
</body>
</html>

